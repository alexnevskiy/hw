# Блокирующий TCP чат

Разрабатывается на Java.

[Код сервера](https://github.com/alexnevskiy/ServerTCP) (сам по себе сервер работает, но многих возможностей ещё нет, например, пересылка файлов не реализована, хотя в классе *Message* написана [но не факт, что правильно]).

[Код клиента](https://github.com/alexnevskiy/ClientTCP) (та же самая история).

## Протокол

Протокол подразумевает следующую последовательность действий:

1. **Установка соединения**. Может быть только первым, в остальных ситуациях не является корректным.
2. **Передача данных (сообщения)**. Может выполняться в любой момент между установкой соединения и его завершением.
3. **Завершение соединения**. Может быть выполнено только после установки соединения.

### Пакет

Пакет имеет максимальный размер 4 Гб, а пакет для отправки размера сообщения - 4 байта.

Все используемые строки (time, name, text, fileName) в кодировке UTF-8.

#### Поля пакета

Пакет имеет следующие поля:

- **time** - точное время получения пакета сервером. Поле может быть пустым. Заполняется сервером. При обработке пакета на стороне сервера содержимое игнорируется.
- **name** - имя отправителя сообщения. Поле может быть пустым. Заполняется сервером. При обработке пакета на стороне сервера содержимое игнорируется, чтобы избежать отправки сообщений от чужого имени.
- **text** - текст сообщения. Поле не может быть пустым. Заполняется клиентом или сервером.
- **fileName** - название файла. Поле может быть пустым. Заполняется клиентом. Одновременно заполнено или пустое вместе с *fileSize*.
- **fileSize** - размер файла (long). Поле может быть пустым. Заполняется клиентом. Одновременно заполнено или пустое вместе с *fileName*.

### Установка соединения

Подключение к серверу или же установка соединения происходит со стороны клиента путём отправки сообщения, где в поле *text* находится имя пользователя, на серверный сокет с указанным хостом и портом. Со стороны сервера для каждого нового подключения создаётся сокет. При некорректном имени сервер вышлет клиенту сообщение с ошибкой (например, что такое имя уже занято) и будет ожидать повторного сообщения с именем от пользователя. Если же имя является корректным, то сервер отсылает всем подключённым пользователям (в том числе и новому) сообщение о том, что новый клиент успешно вошёл в чат. Клиент в свою очередь ожидает ответа от сервера и при получении сообщения сверяет поле *text* c подтверждающей фразой. Если фраза совпала, то соединение можно считать установленным, и пользователь может отправлять сообщения, если же нет, то процедура повторяется вновь с момента отправки имени до тех пор, пока имя не будет считаться правильным.

### Передача данных (сообщения)

#### Отправка сообщения от клиента на сервер

При отправке сообщения со стороны клиента на сервер создаётся пакет и заполняются его поля:

- **time**: пустое поле.
- **name**: пустое поле.
- **text**: содержит текст сообщения, которое отправляет пользователь, не может быть пустым.
- **fileName**: поле может быть либо одновременно пустым с *fileSize*, либо одновременно заполненным, если сообщение отправляется с вложением. Заполняется названием файла с его разрешением (если имеется).
- **fileSize**: поле может быть либо одновременно пустым с *fileName*, либо одновременно заполненным, если сообщение отправляется с вложением. Размер файла указывается в байтах.

После создания сообщения на сервер отсылается размер сообщения (4 байта), затем само сообщение, и если были заполнены поля *fileName* и *fileSize*, то отправляется файл. Если файл превышает размер 4 Гб, то он фрагментируется, и отправляется по частям.

#### Отправка сообщения от сервера к клиенту

При отправке сообщения со стороны сервера к клиенту создаётся пакет и заполняются его поля:

- **time**: заполняется точным временем сервера при получении сообщения в следующем формате: "yyyy-MM-dd'T'HH:mm:ssZ". Часовой пояс указывается локальный для сервера, например, +0300. На стороне клиента производится преобразование часового пояса на его локальный.
- **name**: заполняется тем именем пользователя, от сокета которого пришло сообщение (сервер хранит привязку сокета к имени клиента).
- **text**: содержит текст сообщения, которое отправил пользователь, не может быть пустым.
- **fileName**: поле может быть либо одновременно пустым с *fileSize*, либо одновременно заполненным, если сообщение отправляется с вложением. Заполняется названием файла с его разрешением (если имеется).
- **fileSize**: поле может быть либо одновременно пустым с *fileName*, либо одновременно заполненным, если сообщение отправляется с вложением. Размер файла указывается в байтах.

После создания сообщения всем пользователям поочерёдно отсылается размер сообщения (4 байта), затем само сообщение, и если были заполнены поля *fileName* и *fileSize*, то отправляется файл. Если файл превышает размер 4 Гб, то он фрагментируется, и отправляется по частям.

### Завершение соединения

Завершение соединения может произойти как со стороны клиента, так и со стороны сервера.

#### Со стороны клиента

Завершение соединения со стороны клиента может произойти в двух случаях:

- При создании сообщения с "кодовым словом" *-exit*.
- При закрытии приложения, и в последствии при закрытии клиентского сокета.

В вышеописанных случаях сервер со своей стороны также должен закрыть клиентский сокет.

#### Со стороны сервера

Завершение соединения со стороны сервера может произойти лишь в одном случае: сервер прекратил свою работу (простыми словами сервер выключили). При этом сервер должен закрыть все клиентские сокеты. Клиенты же со своей стороны также должны закрыть сокеты.